generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  VOLUNTEER
  DONOR
}

enum VolunteerStatus {
  PENDING
  ACTIVE
  INACTIVE
  BLOCKED
}

enum MembershipStatus {
  UNPAID
  PAID
  EXEMPTED
}

enum CertificateType {
  APPRECIATION
  PARTICIPATION
  ACHIEVEMENT
  TRAINING
  CUSTOM
}

model User {
  id                  String    @id @default(uuid())
  username            String?   @unique
  email               String    @unique
  password_hash       String
  role                UserRole  @default(VOLUNTEER)
  is_active           Boolean   @default(true)
  is_blocked          Boolean   @default(false)
  blocked_reason      String?
  blocked_by_id       String?
  blocked_at          DateTime?
  last_login          DateTime?
  password_reset_token String?
  password_reset_expires DateTime?
  email_verified      Boolean   @default(false)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  // Relations
  volunteer_profile   Volunteer?
  member_profile      MemberProfile?
  blocked_by          User?     @relation("UserBlockedBy", fields: [blocked_by_id], references: [id])
  blocks_issued       User[]    @relation("UserBlockedBy")
  donations           Donation[] 
  certificates_issued Certificate[] @relation("CertificateIssuer")
  messages_sent       Message[]     @relation("MessageSender")
  message_recipients  MessageRecipient[]
  notices_published   Notice[]
  manager_permissions ManagerPermission?
  audit_logs          AuditLog[]
  campaigns_created   Campaign[]
  files_uploaded      File[]
  transparency_reports TransparencyReport[]
  events_created      Event[]

  @@map("users")
}

model Volunteer {
  id                  String    @id @default(uuid())
  user_id             String    @unique
  unique_id           String?   @unique // NGO-2025-00001
  full_name           String
  email               String    @unique
  phone               String?
  profile_photo       String?
  bio                 String?
  skills              Json?     // Array of strings
  availability        String?
  motivation          String?
  emergency_contact   Json?
  
  status              VolunteerStatus @default(PENDING)
  
  membership_status   MembershipStatus @default(UNPAID)
  membership_amount   Decimal?  @db.Decimal(10, 2)
  membership_paid_date DateTime?
  membership_receipt_url String?
  
  id_card_number      String?   @unique
  id_card_url         String?
  id_card_qr_code     String?
  id_card_issued_date DateTime?
  id_card_status      String?   @default("active") // active, revoked
  
  approval_date       DateTime?
  join_date           DateTime?
  activated_manually  Boolean   @default(false)
  activated_by_id     String?
  
  public_profile      Boolean   @default(false)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  user                User      @relation(fields: [user_id], references: [id])
  certificates        Certificate[]
  tasks               VolunteerTask[]
  groups              VolunteerGroup[]  @relation("VolunteerGroups")

  @@map("volunteers")
}

model VolunteerGroup {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  
  volunteers  Volunteer[] @relation("VolunteerGroups")

  @@map("volunteer_groups")
}

model ManagerPermission {
  id                String   @id @default(uuid())
  user_id           String   @unique
  can_add_volunteers Boolean @default(false)
  can_delete_volunteers Boolean @default(false)
  can_block_users   Boolean @default(false)
  can_view_transactions Boolean @default(false)
  can_view_receipts Boolean @default(false)
  can_generate_certificates Boolean @default(false)
  can_send_messages Boolean @default(false)
  can_create_campaigns Boolean @default(false)
  can_edit_notices  Boolean @default(false)
  can_approve_volunteers Boolean @default(false)
  assigned_by_id    String?
  assigned_at       DateTime?
  updated_at        DateTime @updatedAt

  user              User     @relation(fields: [user_id], references: [id])

  @@map("manager_permissions")
}

model Campaign {
  id              String    @id @default(uuid())
  title           String
  description     String?
  goal_amount     Decimal   @db.Decimal(10, 2)
  raised_amount   Decimal   @default(0) @db.Decimal(10, 2)
  start_date      DateTime?
  end_date        DateTime?
  status          String    @default("active") // active, completed, paused
  banner_image    String?
  gallery_images  Json?
  created_by_id   String
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  created_by      User      @relation(fields: [created_by_id], references: [id])
  donations       Donation[]

  @@map("campaigns")
}

model Donation {
  id              String    @id @default(uuid())
  donor_name      String?
  donor_email     String?
  donor_phone     String?
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  payment_method  String?   // stripe, bank_transfer, cash
  payment_id      String?
  transaction_id  String?   @unique
  
  campaign_id     String?
  user_id         String?   // If logged in
  
  is_anonymous    Boolean   @default(false)
  receipt_url     String?
  certificate_url String?
  certificate_id  String?   @unique
  
  status          String    @default("completed") // pending, completed, failed
  
  is_recurring    Boolean   @default(false)
  recurring_frequency String?
  tax_exemption_claimed Boolean @default(false)

  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  campaign        Campaign? @relation(fields: [campaign_id], references: [id])
  user            User?     @relation(fields: [user_id], references: [id])
  certificate     Certificate? @relation(fields: [certificate_id], references: [id])

  @@map("donations")
}

model CertificateTemplate {
  id              String    @id @default(uuid())
  template_name   String
  template_type   CertificateType
  design_url      String?
  template_fields Json?     // [{name, type, placeholder}]
  is_active       Boolean   @default(true)
  created_by_id   String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  certificates    Certificate[]

  @@map("certificate_templates")
}

model Certificate {
  id                  String    @id @default(uuid())
  certificate_number  String    @unique
  recipient_volunteer_id String?
  recipient_name      String?   // For external donors
  recipient_email     String?
  
  template_id         String
  certificate_type    String
  issued_for          String?   // Reason
  certificate_url     String
  field_values        Json?
  issued_by_id        String?
  issue_date          DateTime  @default(now())
  created_at          DateTime  @default(now())

  template            CertificateTemplate @relation(fields: [template_id], references: [id])
  recipient_volunteer Volunteer? @relation(fields: [recipient_volunteer_id], references: [id])
  issued_by           User?      @relation("CertificateIssuer", fields: [issued_by_id], references: [id])
  donation            Donation?

  @@map("certificates")
}

model Message {
  id              String    @id @default(uuid())
  sender_id       String
  recipient_type  String    // individual, all_volunteers, active_volunteers
  subject         String
  message         String
  priority        String    @default("normal")
  send_email      Boolean   @default(false)
  created_at      DateTime  @default(now())

  sender          User      @relation("MessageSender", fields: [sender_id], references: [id])
  recipients      MessageRecipient[]

  @@map("messages")
}

model MessageRecipient {
  id              String    @id @default(uuid())
  message_id      String
  recipient_id    String
  is_read         Boolean   @default(false)
  read_at         DateTime?
  created_at      DateTime  @default(now())

  message         Message   @relation(fields: [message_id], references: [id])
  recipient       User      @relation(fields: [recipient_id], references: [id])

  @@map("message_recipients")
}

model Notice {
  id              String    @id @default(uuid())
  title           String
  content         String
  notice_type     String    // general, urgent, event, policy
  target_audience String    // public, volunteers, donors
  attachments     Json?     // Array of URLs
  views_count     Int       @default(0)
  expiry_date     DateTime?
  is_active       Boolean   @default(true)
  published_by_id String
  published_at    DateTime  @default(now())
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  published_by    User      @relation(fields: [published_by_id], references: [id])

  @@map("notices")
}

model AuditLog {
  id              String    @id @default(uuid())
  user_id         String?
  action          String
  entity_type     String
  entity_id       String?
  action_details  Json?
  old_values      Json?
  new_values      Json?
  ip_address      String?
  user_agent      String?
  timestamp       DateTime  @default(now())

  user            User?     @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

model VolunteerTask {
  id              String    @id @default(uuid())
  volunteer_id    String
  title           String
  description     String?
  status          String    @default("pending")
  due_date        DateTime?
  completed_at    DateTime?
  created_at      DateTime  @default(now())

  volunteer       Volunteer @relation(fields: [volunteer_id], references: [id])

  @@map("volunteer_tasks")
}

model TransparencyReport {
  id              String    @id @default(uuid())
  report_type     String    // annual, financial, audit
  title           String
  financial_year  String?
  file_url        String
  published_by_id String
  published_at    DateTime  @default(now())

  published_by    User      @relation(fields: [published_by_id], references: [id])
  
  @@map("transparency_reports")
}

model File {
  id              String    @id @default(uuid())
  filename        String
  url             String
  mimetype        String
  size            Int
  uploaded_by_id  String?
  created_at      DateTime  @default(now())
  uploaded_by     User?     @relation(fields: [uploaded_by_id], references: [id])

  @@map("files")
}

model MemberProfile {
  id              String    @id @default(uuid())
  user_id         String    @unique
  
  // Bank Details
  bank_name       String
  account_number  String
  ifsc_code       String
  branch_name     String?
  account_type    String    // Savings/Current

  // Nominee Details
  nominee_name    String
  nominee_relation String
  nominee_dob     DateTime?
  nominee_phone   String?
  nominee_address String?
  
  // Nominee Bank Details
  nominee_bank_name     String?
  nominee_account_number String?
  nominee_ifsc_code     String?

  user            User      @relation(fields: [user_id], references: [id])
  family_members  FamilyMember[]

  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@map("member_profiles")
}

model FamilyMember {
  id              String    @id @default(uuid())
  member_id       String
  full_name       String
  relationship    String
  dob             DateTime?
  occupation      String?
  is_dependent    Boolean   @default(false)

  member          MemberProfile @relation(fields: [member_id], references: [id])

  @@map("family_members")
}

model Event {
  id          String   @id @default(uuid())
  title       String
  description String
  date        DateTime
  time        String?
  location    String?
  category    String?  // 'cultural', 'health', 'education', 'fundraiser', 'general'
  capacity    Int      @default(100)
  registered  Int      @default(0)
  is_free     Boolean  @default(true)
  image_url   String?
  attachments Json?    // Keep compatibility for now if needed, or just use image_url

  created_by_id String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  created_by  User     @relation(fields: [created_by_id], references: [id])

  @@map("events")
}
